ISecL v1.4 Server containers
==========================
This repo is to create an image for ISecL Certificate Management Service container. 
Below instructions help in building and running the Certificate Management Service 
contianer on Docker runtime.

Pre-requisites
----------------------

* Install Docker runtime: yum install -y docker
* Start docker service: systemctl start docker
* Setup the docker proxy settings if required and reload and daemon
* Install docker-compose: 
    sudo curl -L "https://github.com/docker/compose/releases/download/1.23.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
	
	Verify if the docker-compose was installed correctly by running the "docker-compose version" command

    More info: https://docs.docker.com/compose/install/

Building the containers
-----------------------

ISecL sever components could be built using docker-compose or vanilla docker commands. 
This section explains building the images using docker-compose

* **Directory structure**
   ISecL Certificate Management Service container ontainer can be built using docker-compose. 
    For building the containers, below files and directories are expected 
    in the build(current) directory where the docker-compse.yml is exists.

    +-- docker_compose.yml 
    |
    +-- Dockerfile: Invoked by docker-compose to buid the image
    |
    +-- cms-*.bin: Installer
    |
    +-- entrypoint.sh: Entrypscript

* **Container Environment**
    ISecL Containers are built over RHEL 7.5 base image. When creating the container
    image, the installers are run such that the static content is extracted  
    and placed in the right locations. All setup tasks are performed during the image launch

* **Docker build command**
	* The docker build command requires the path of the cms installer and the docker file.
	  If the current directory where the command is being run from has all the required files used 
	  to build the image, then the following command can be used.
	  
	docker build -t cms:latest -f Dockerfile .
	
* **Docker save command**	
	* The docker image built can be saved to any tar file using the command below.
		docker save isecl/cms:latest > docker-tservice.tar
	
Running the container
---------------------

* **Create volumes**
    All the configuration, logs and non-static content generated by the service
    is stored as part of the volumes so that the container remains 
    stateless. So, the below volumes created by the Certificate Management container.

    Refer [Docker Volumes](https://docs.docker.com/storage/volumes/) for volume 
    management on Docker


    * **Threat Service volumes** *

    | Type          | Name                               | Container Path                     |
    |:-------------:|:----------------------------------:|:----------------------------------:|
    | Volume        | cms-config-volume                  | /etc/cms
    | Volume        | cms-log-volume                     | /var/log/cms 

    Volumes would be automatically created by docker-compose. 

* **Running ISecL Certificate Management Service image**

    Running the ISecL Certificate Management Service requires certain configuration varables to be set
	in the docker_compose.yml. If the value are not provided, the default values will the used.    

    * **Command to bring up the container** *
    docker-compose up

    `docker ps` should show the Certificate Management Service container as below
        cms_1 		

* **Restarting the Container**

    Once the container is down/stopped (docker-compose down), the container can be brought back up again
	using the below command:

	"docker-compose up" to start the container again
